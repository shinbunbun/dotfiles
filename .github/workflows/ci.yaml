name: CI & Deploy

on:
  push:
  workflow_dispatch:
    inputs:
      skip_deploy:
        description: 'Skip deployment step'
        required: false
        type: boolean
        default: false

jobs:
  format-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Nix with flakes enabled
        uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
      - name: Check Nix code formatting
        run: nix fmt -- --fail-on-change

  build-nixos:
    needs: format-check
    runs-on: ubuntu-latest
    strategy:
      matrix:
        configuration: [homeMachine]
    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force

      - uses: actions/checkout@v4

      - name: Install Nix with flakes enabled
        uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            substituters = https://cache.nixos.org https://cache.shinbunbun.com/main
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= main:EMoov6FniyxjYhY24OcZ02dOIWKu4feJH7uGRjgwwUc=
            fallback = true
            connect-timeout = 5

      - name: Setup SOPS
        run: |
          sudo mkdir -p /var/lib/sops-nix
          echo "${{ secrets.SOPS_AGE_KEY }}" | sudo tee /var/lib/sops-nix/key.txt > /dev/null
          sudo chmod 600 /var/lib/sops-nix/key.txt

      - name: Setup Attic authentication
        run: |
          mkdir -p ~/.config/nix
          cat > ~/.config/nix/nix.conf << EOF
          netrc-file = $HOME/.netrc
          EOF
          cat > ~/.netrc << EOF
          machine cache.shinbunbun.com
          password ${{ secrets.ATTIC_READ_TOKEN }}
          EOF
          chmod 600 ~/.netrc

      - name: Build NixOS configuration
        run: |
          nix build .#nixosConfigurations.${{ matrix.configuration }}.config.system.build.toplevel \
            --print-build-logs \
            --show-trace \
            --out-link result-${{ matrix.configuration }}

      - name: Install Attic CLI
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: nix profile install github:zhaofengli/attic

      - name: Configure and push to Attic cache
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          attic login ci https://cache.shinbunbun.com ${{ secrets.ATTIC_TOKEN }}
          attic cache create main || echo "Cache already exists"
          attic push main result-${{ matrix.configuration }}
        continue-on-error: true

  build-darwin:
    needs: format-check
    runs-on: macos-latest
    strategy:
      matrix:
        configuration: [macbook]
    steps:
      - uses: actions/checkout@v4

      - name: Install Nix with flakes enabled
        uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            substituters = https://cache.nixos.org https://cache.shinbunbun.com/main
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= main:EMoov6FniyxjYhY24OcZ02dOIWKu4feJH7uGRjgwwUc=
            fallback = true
            connect-timeout = 5

      - name: Setup SOPS
        run: |
          sudo mkdir -p /var/lib/sops-nix
          echo "${{ secrets.SOPS_AGE_KEY }}" | sudo tee /var/lib/sops-nix/key.txt > /dev/null
          sudo chmod 600 /var/lib/sops-nix/key.txt

      - name: Setup Attic authentication
        run: |
          mkdir -p ~/.config/nix
          cat > ~/.config/nix/nix.conf << EOF
          netrc-file = $HOME/.netrc
          EOF
          cat > ~/.netrc << EOF
          machine cache.shinbunbun.com
          password ${{ secrets.ATTIC_READ_TOKEN }}
          EOF
          chmod 600 ~/.netrc

      - name: Build Darwin configuration
        run: |
          nix build .#darwinConfigurations.${{ matrix.configuration }}.config.system.build.toplevel \
            --print-build-logs \
            --show-trace

  build-devshell:
    needs: format-check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Nix with flakes enabled
        uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Build development shell
        run: |
          nix build .#devShells.x86_64-linux.default \
            --print-build-logs \
            --show-trace

      - name: Check flake
        run: nix flake check --print-build-logs

  deploy-nixos:
    name: Deploy to NixOS
    needs: build-nixos
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push' && !inputs.skip_deploy

    steps:
      - uses: actions/checkout@v4

      - name: Install Nix with flakes enabled
        uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Install cloudflared
        run: |
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared
          sudo mv cloudflared /usr/local/bin/

      - name: Setup SSH for deployment
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          cat >> ~/.ssh/config << 'EOF'
          Host homemachine
            HostName ssh.shinbunbun.com
            User deploy
            IdentityFile ~/.ssh/deploy_key
            ProxyCommand cloudflared access ssh --hostname %h
            StrictHostKeyChecking no
          EOF

      - name: Test SSH connectivity
        run: |
          ssh homemachine 'echo "SSH connection via Cloudflare Tunnel OK"'
        timeout-minutes: 2

      - name: Deploy to homeMachine
        run: |
          nix run github:serokell/deploy-rs -- \
            --skip-checks \
            .#homeMachine

      - name: Post-deployment health check
        run: |
          sleep 10
          ssh homemachine 'systemctl is-active atticd && echo "Attic OK" || echo "Warning: Attic not active"'
          ssh homemachine 'systemctl is-active prometheus && echo "Prometheus OK" || echo "Warning: Prometheus not active"'
        continue-on-error: true
