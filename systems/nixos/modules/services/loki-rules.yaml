# Loki用アラートルール
# このファイルはLokiのルーラーで評価される
groups:
  - name: logs_analysis
    interval: 30s
    rules:
      # 高エラーレート（5分窓の警告）（Lokiサービス自身のログを除外）
      - alert: HighErrorRate5m
        expr: |
          sum(rate({job="systemd-journal", service!="loki"} |= "error" [5m])) by (host) > 0.5
        for: 5m
        labels:
          severity: warning
          window: 5m
        annotations:
          summary: "High error rate detected on {{ $labels.host }} (5m window)"
          description: "Error rate is {{ $value }} errors/sec over 5 minutes on {{ $labels.host }}"

      # 高エラーレート（30分窓の重大）（Lokiサービス自身のログを除外）
      - alert: HighErrorRate30m
        expr: |
          sum(rate({job="systemd-journal", service!="loki"} |= "error" [30m])) by (host) > 0.3
        for: 10m
        labels:
          severity: critical
          window: 30m
        annotations:
          summary: "Sustained high error rate on {{ $labels.host }} (30m window)"
          description: "Error rate is {{ $value }} errors/sec sustained over 30 minutes on {{ $labels.host }}"

      # Nginx 5xxエラー（5分窓）
      - alert: HighNginx5xxRate5m
        expr: |
          sum(rate({job="nginx", log_type="access"} | json | status >= 500 [5m])) by (host) > 0.1
        for: 5m
        labels:
          severity: warning
          window: 5m
        annotations:
          summary: "High Nginx 5xx error rate on {{ $labels.host }} (5m window)"
          description: "Nginx 5xx error rate is {{ $value }} errors/sec over 5 minutes"

      # Nginx 5xxエラー（30分窓）
      - alert: HighNginx5xxRate30m
        expr: |
          sum(rate({job="nginx", log_type="access"} | json | status >= 500 [30m])) by (host) > 0.05
        for: 10m
        labels:
          severity: critical
          window: 30m
        annotations:
          summary: "Sustained Nginx 5xx errors on {{ $labels.host }} (30m window)"
          description: "Nginx 5xx error rate is {{ $value }} errors/sec sustained over 30 minutes"

      # サービス再起動検知（systemdからの起動メッセージのみ、Lokiサービス自身のログを除外）
      - alert: ServiceRestarting
        expr: |
          sum(count_over_time({job="systemd-journal", unit=~".+\\.service", service!="loki"} |= "Started" |= "systemd" [5m])) by (unit, host) > 3
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Service {{ $labels.unit }} restarting frequently on {{ $labels.host }}"
          description: "Service {{ $labels.unit }} has restarted {{ $value }} times in 5 minutes"

      # OOMキラー検知（Lokiサービス自身のログを除外）
      - alert: OOMKillerActive
        expr: |
          sum(count_over_time({job="systemd-journal"} != "loki" |= "Out of memory" |= "Kill process" [10m])) by (host) > 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "OOM killer activated on {{ $labels.host }}"
          description: "Out of Memory killer has been triggered {{ $value }} times in the last 10 minutes"

      # 認証失敗の急増（実際の認証失敗のみ）
      - alert: AuthenticationFailures
        expr: |
          sum(count_over_time({job="systemd-journal", service!="loki"} |~ "authentication failure|Failed password|pam_unix.*authentication failure" [10m])) by (host) > 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Multiple authentication failures on {{ $labels.host }}"
          description: "{{ $value }} authentication failures detected in the last 10 minutes"

      # ディスクI/Oエラー（Lokiサービス自身のログを除外）
      - alert: DiskIOErrors
        expr: |
          sum(count_over_time({job="systemd-journal"} != "loki" |~ "I/O error|Input/output error" [5m])) by (host) > 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Disk I/O errors detected on {{ $labels.host }}"
          description: "{{ $value }} disk I/O errors in the last 5 minutes"

      # カーネルパニック/クラッシュ検知（Lokiサービス自身のログを除外）
      - alert: KernelPanic
        expr: |
          sum(count_over_time({job="systemd-journal"} != "loki" |~ "kernel panic|kernel BUG|Oops" [5m])) by (host) > 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Kernel panic/crash detected on {{ $labels.host }}"
          description: "Kernel panic or crash signatures detected"

  # RouterOS監視アラート
  - name: routeros_monitoring
    interval: 30s
    rules:
      # RouterOS再起動検出
      - alert: RouterOSReboot
        expr: |
          sum(count_over_time({job="routeros", topic="system"} |~ "system,info|logged in|system started" [10m])) by (host) > 0
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "RouterOS reboot detected on {{ $labels.host }}"
          description: "RouterOS has been restarted or system startup detected"

      # RouterOS設定変更検出
      - alert: RouterOSConfigChange
        expr: |
          sum(count_over_time({job="routeros", topic="system"} |~ "configuration|changed by" [5m])) by (host) > 0
        for: 1m
        labels:
          severity: info
        annotations:
          summary: "RouterOS configuration changed on {{ $labels.host }}"
          description: "RouterOS configuration has been modified"

      # 認証失敗の多発（ブルートフォース攻撃の可能性）
      - alert: RouterOSAuthFailures
        expr: |
          sum(count_over_time({job="routeros", topic="system"} |~ "login failure|authentication failed|failed login" [10m])) by (host) > 5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Multiple authentication failures on RouterOS {{ $labels.host }}"
          description: "{{ $value }} authentication failures detected in the last 10 minutes - possible brute force attack"

      # ファイアウォールドロップの急増
      - alert: RouterOSFirewallDrops
        expr: |
          sum(rate({job="routeros", topic="firewall"} |~ "dropped|reject" [5m])) by (host) > 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High firewall drop rate on RouterOS {{ $labels.host }}"
          description: "Firewall is dropping {{ $value }} packets/sec - possible attack or misconfiguration"

      # VPN接続の異常切断
      - alert: RouterOSVPNDisconnect
        expr: |
          sum(count_over_time({job="routeros", topic="ipsec"} |~ "connection terminated|connection closed|phase1 failed" [10m])) by (host) > 3
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "VPN connection issues on RouterOS {{ $labels.host }}"
          description: "{{ $value }} VPN disconnections detected in the last 10 minutes"

      # DHCP枯渇警告
      - alert: RouterOSDHCPPoolExhausted
        expr: |
          sum(count_over_time({job="routeros", topic="dhcp"} |~ "no free address|address pool exhausted" [10m])) by (host) > 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "DHCP pool exhausted on RouterOS {{ $labels.host }}"
          description: "DHCP address pool has no available addresses"

      # DHCPエラーの急増
      - alert: RouterOSDHCPErrors
        expr: |
          sum(rate({job="routeros", topic="dhcp", severity=~"error|critical"} [5m])) by (host) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High DHCP error rate on RouterOS {{ $labels.host }}"
          description: "DHCP service experiencing {{ $value }} errors/sec"

      # DNS解決エラー急増
      - alert: RouterOSDNSErrors
        expr: |
          sum(rate({job="routeros", topic="dns"} |~ "server failure|timeout|resolution failed" [5m])) by (host) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High DNS error rate on RouterOS {{ $labels.host }}"
          description: "DNS is experiencing {{ $value }} errors/sec"

      # 無線LAN接続問題
      - alert: RouterOSWirelessIssues
        expr: |
          sum(rate({job="routeros", topic="wireless", severity=~"error|warning"} [5m])) by (host) > 0.5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Wireless issues detected on RouterOS {{ $labels.host }}"
          description: "Wireless interface experiencing {{ $value }} issues/sec"

      # RouterOSクリティカルエラー
      - alert: RouterOSCriticalError
        expr: |
          sum(count_over_time({job="routeros", severity="critical"} [5m])) by (host, topic) > 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Critical error on RouterOS {{ $labels.host }}"
          description: "Critical error detected in {{ $labels.topic }}: {{ $value }} occurrences in 5 minutes"

      # RouterOSシステムエラーレート
      - alert: RouterOSHighErrorRate
        expr: |
          sum(rate({job="routeros", severity=~"error|critical"} [10m])) by (host) > 0.5
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High error rate on RouterOS {{ $labels.host }}"
          description: "RouterOS is experiencing {{ $value }} errors/sec sustained over 10 minutes"