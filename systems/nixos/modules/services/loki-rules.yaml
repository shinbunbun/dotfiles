# Loki用アラートルール
# このファイルはLokiのルーラーで評価される
groups:
  - name: logs_analysis
    interval: 30s
    rules:
      # 高エラーレート（5分窓の警告）（Lokiサービス自身のログを除外）
      - alert: HighErrorRate5m
        expr: |
          sum(rate({job="systemd-journal", service!="loki"} |= "error" [5m])) by (host) > 0.5
        for: 5m
        labels:
          severity: warning
          window: 5m
        annotations:
          summary: "High error rate detected on {{ $labels.host }} (5m window)"
          description: "Error rate is {{ $value }} errors/sec over 5 minutes on {{ $labels.host }}"

      # 高エラーレート（30分窓の重大）（Lokiサービス自身のログを除外）
      - alert: HighErrorRate30m
        expr: |
          sum(rate({job="systemd-journal", service!="loki"} |= "error" [30m])) by (host) > 0.3
        for: 10m
        labels:
          severity: critical
          window: 30m
        annotations:
          summary: "Sustained high error rate on {{ $labels.host }} (30m window)"
          description: "Error rate is {{ $value }} errors/sec sustained over 30 minutes on {{ $labels.host }}"

      # Nginx 5xxエラー（5分窓）
      - alert: HighNginx5xxRate5m
        expr: |
          sum(rate({job="nginx", log_type="access"} | json | status >= 500 [5m])) by (host) > 0.1
        for: 5m
        labels:
          severity: warning
          window: 5m
        annotations:
          summary: "High Nginx 5xx error rate on {{ $labels.host }} (5m window)"
          description: "Nginx 5xx error rate is {{ $value }} errors/sec over 5 minutes"

      # Nginx 5xxエラー（30分窓）
      - alert: HighNginx5xxRate30m
        expr: |
          sum(rate({job="nginx", log_type="access"} | json | status >= 500 [30m])) by (host) > 0.05
        for: 10m
        labels:
          severity: critical
          window: 30m
        annotations:
          summary: "Sustained Nginx 5xx errors on {{ $labels.host }} (30m window)"
          description: "Nginx 5xx error rate is {{ $value }} errors/sec sustained over 30 minutes"

      # サービス再起動検知（systemdからの起動メッセージのみ、Lokiサービス自身のログを除外）
      - alert: ServiceRestarting
        expr: |
          sum(count_over_time({job="systemd-journal", unit=~".+\\.service", service!="loki"} |= "Started" |= "systemd" [5m])) by (unit, host) > 3
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Service {{ $labels.unit }} restarting frequently on {{ $labels.host }}"
          description: "Service {{ $labels.unit }} has restarted {{ $value }} times in 5 minutes"

      # OOMキラー検知（Lokiサービス自身のログを除外）
      - alert: OOMKillerActive
        expr: |
          sum(count_over_time({job="systemd-journal"} != "loki" |= "Out of memory" |= "Kill process" [10m])) by (host) > 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "OOM killer activated on {{ $labels.host }}"
          description: "Out of Memory killer has been triggered {{ $value }} times in the last 10 minutes"

      # 認証失敗の急増（実際の認証失敗のみ）
      - alert: AuthenticationFailures
        expr: |
          sum(count_over_time({job="systemd-journal", service!="loki"} |~ "authentication failure|Failed password|pam_unix.*authentication failure" [10m])) by (host) > 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Multiple authentication failures on {{ $labels.host }}"
          description: "{{ $value }} authentication failures detected in the last 10 minutes"

      # ディスクI/Oエラー（Lokiサービス自身のログを除外）
      - alert: DiskIOErrors
        expr: |
          sum(count_over_time({job="systemd-journal"} != "loki" |~ "I/O error|Input/output error" [5m])) by (host) > 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Disk I/O errors detected on {{ $labels.host }}"
          description: "{{ $value }} disk I/O errors in the last 5 minutes"

      # カーネルパニック/クラッシュ検知（Lokiサービス自身のログを除外）
      - alert: KernelPanic
        expr: |
          sum(count_over_time({job="systemd-journal"} != "loki" |~ "kernel panic|kernel BUG|Oops" [5m])) by (host) > 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Kernel panic/crash detected on {{ $labels.host }}"
          description: "Kernel panic or crash signatures detected"