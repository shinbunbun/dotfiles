name: CI & Deploy

on:
  push:
  workflow_dispatch:
    inputs:
      skip_deploy:
        description: 'Skip deployment step'
        required: false
        type: boolean
        default: false

jobs:
  format-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Nix with flakes enabled
        uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
      - name: Check Nix code formatting
        run: nix fmt -- --fail-on-change

  build-nixos:
    needs: format-check
    runs-on: ubuntu-latest
    strategy:
      matrix:
        configuration: [homeMachine]
    steps:

      - uses: actions/checkout@v4

      - name: Install Nix with flakes enabled
        uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            substituters = https://cache.nixos.org https://cache.shinbunbun.com/main
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= main:EMoov6FniyxjYhY24OcZ02dOIWKu4feJH7uGRjgwwUc=
            fallback = true
            connect-timeout = 5

      - name: Setup SOPS
        run: |
          sudo mkdir -p /var/lib/sops-nix
          echo "${{ secrets.SOPS_AGE_KEY }}" | sudo tee /var/lib/sops-nix/key.txt > /dev/null
          sudo chmod 600 /var/lib/sops-nix/key.txt

      - name: Setup Attic authentication
        run: |
          mkdir -p ~/.config/nix
          cat > ~/.config/nix/nix.conf << EOF
          netrc-file = $HOME/.netrc
          EOF
          cat > ~/.netrc << EOF
          machine cache.shinbunbun.com
          password ${{ secrets.ATTIC_READ_TOKEN }}
          EOF
          chmod 600 ~/.netrc

      - name: Build NixOS configuration
        run: |
          nix build .#nixosConfigurations.${{ matrix.configuration }}.config.system.build.toplevel \
            --print-build-logs \
            --show-trace \
            --out-link result-${{ matrix.configuration }}

      - name: Configure and push to Attic cache
        if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/fix/deploy') && github.event_name == 'push'
        run: |
          nix build .#attic --out-link attic-cli
          ./attic-cli/bin/attic login ci https://cache.shinbunbun.com ${{ secrets.ATTIC_TOKEN }}
          ./attic-cli/bin/attic cache create main || echo "Cache already exists"

          # attic CLIè‡ªä½“ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ãƒ—ãƒƒã‚·ãƒ¥ï¼ˆæ¬¡å›žCIå®Ÿè¡Œã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆï¼‰
          echo "Pushing attic-cli to cache..."
          ./attic-cli/bin/attic push main attic-cli || echo "Failed to push attic-cli (non-fatal)"

          # ã‚·ã‚¹ãƒ†ãƒ ãƒ“ãƒ«ãƒ‰ã‚’ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯ä»˜ãã§pushï¼ˆå¤§ããªãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå¯¾ç­–ï¼‰
          echo "Pushing system build to cache..."
          for i in {1..3}; do
            if ./attic-cli/bin/attic push main result-${{ matrix.configuration }}; then
              break
            fi
            echo "Retry $i/3 after error..."
            sleep 10
          done
        continue-on-error: true

  build-darwin:
    needs: format-check
    runs-on: macos-latest
    strategy:
      matrix:
        configuration: [macbook]
    steps:
      - uses: actions/checkout@v4

      - name: Install Nix with flakes enabled
        uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            substituters = https://cache.nixos.org https://cache.shinbunbun.com/main
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= main:EMoov6FniyxjYhY24OcZ02dOIWKu4feJH7uGRjgwwUc=
            fallback = true
            connect-timeout = 5

      - name: Setup SOPS
        run: |
          sudo mkdir -p /var/lib/sops-nix
          echo "${{ secrets.SOPS_AGE_KEY }}" | sudo tee /var/lib/sops-nix/key.txt > /dev/null
          sudo chmod 600 /var/lib/sops-nix/key.txt

      - name: Setup Attic authentication
        run: |
          mkdir -p ~/.config/nix
          cat > ~/.config/nix/nix.conf << EOF
          netrc-file = $HOME/.netrc
          EOF
          cat > ~/.netrc << EOF
          machine cache.shinbunbun.com
          password ${{ secrets.ATTIC_READ_TOKEN }}
          EOF
          chmod 600 ~/.netrc

      - name: Build Darwin configuration
        run: |
          nix build .#darwinConfigurations.${{ matrix.configuration }}.config.system.build.toplevel \
            --print-build-logs \
            --show-trace \
            --out-link result-${{ matrix.configuration }}

      - name: Configure and push to Attic cache
        if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/fix/deploy') && github.event_name == 'push'
        run: |
          nix build .#attic --out-link attic-cli
          ./attic-cli/bin/attic login ci https://cache.shinbunbun.com ${{ secrets.ATTIC_TOKEN }}
          ./attic-cli/bin/attic cache create main || echo "Cache already exists"

          # attic CLIè‡ªä½“ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ãƒ—ãƒƒã‚·ãƒ¥ï¼ˆæ¬¡å›žCIå®Ÿè¡Œã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆï¼‰
          echo "Pushing attic-cli to cache..."
          ./attic-cli/bin/attic push main attic-cli || echo "Failed to push attic-cli (non-fatal)"

          # Darwinãƒ“ãƒ«ãƒ‰ã‚’ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯ä»˜ãã§push
          echo "Pushing Darwin build to cache..."
          for i in {1..3}; do
            if ./attic-cli/bin/attic push main result-${{ matrix.configuration }}; then
              break
            fi
            echo "Retry $i/3 after error..."
            sleep 10
          done
        continue-on-error: true

  build-devshell:
    needs: format-check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Nix with flakes enabled
        uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            substituters = https://cache.nixos.org https://cache.shinbunbun.com/main
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= main:EMoov6FniyxjYhY24OcZ02dOIWKu4feJH7uGRjgwwUc=
            fallback = true
            connect-timeout = 5

      - name: Setup Attic authentication
        run: |
          mkdir -p ~/.config/nix
          cat > ~/.config/nix/nix.conf << EOF
          netrc-file = $HOME/.netrc
          EOF
          cat > ~/.netrc << EOF
          machine cache.shinbunbun.com
          password ${{ secrets.ATTIC_READ_TOKEN }}
          EOF
          chmod 600 ~/.netrc

      - name: Build development shell
        run: |
          nix build .#devShells.x86_64-linux.default \
            --print-build-logs \
            --show-trace \
            --out-link result-devshell

      - name: Configure and push to Attic cache
        if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/fix/deploy') && github.event_name == 'push'
        run: |
          nix build .#attic --out-link attic-cli
          ./attic-cli/bin/attic login ci https://cache.shinbunbun.com ${{ secrets.ATTIC_TOKEN }}
          ./attic-cli/bin/attic cache create main || echo "Cache already exists"

          # attic CLIè‡ªä½“ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ãƒ—ãƒƒã‚·ãƒ¥ï¼ˆæ¬¡å›žCIå®Ÿè¡Œã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆï¼‰
          echo "Pushing attic-cli to cache..."
          ./attic-cli/bin/attic push main attic-cli || echo "Failed to push attic-cli (non-fatal)"

          # devshellãƒ“ãƒ«ãƒ‰ã‚’ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯ä»˜ãã§push
          echo "Pushing devshell build to cache..."
          for i in {1..3}; do
            if ./attic-cli/bin/attic push main result-devshell; then
              break
            fi
            echo "Retry $i/3 after error..."
            sleep 10
          done
        continue-on-error: true

  notify-build-complete:
    name: Notify build completion
    needs: build-nixos
    runs-on: ubuntu-latest
    if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/fix/deploy') && github.event_name == 'push' && !inputs.skip_deploy

    steps:
      - name: Send Discord notification
        run: |
          curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"content\": \"âœ… ãƒ“ãƒ«ãƒ‰å®Œäº†\\n\\n**ãƒ‡ãƒ—ãƒ­ã‚¤æ‰¿èªå¾…ã¡**\\nhttps://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\\n\\nãƒ‡ãƒ—ãƒ­ã‚¤ã‚’é–‹å§‹ã™ã‚‹ã«ã¯ã€ä¸Šè¨˜ãƒªãƒ³ã‚¯ã‹ã‚‰ \`Deploy to NixOS\` ã‚¸ãƒ§ãƒ–ã‚’æ‰¿èªã—ã¦ãã ã•ã„ã€‚\"
            }"

  deploy-nixos:
    name: Deploy to NixOS
    needs: [build-nixos, notify-build-complete]
    runs-on: ubuntu-latest
    if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/fix/deploy') && github.event_name == 'push' && !inputs.skip_deploy
    environment: production

    steps:
      - uses: actions/checkout@v4

      - name: Install Nix with flakes enabled
        uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Install cloudflared
        run: |
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared
          sudo mv cloudflared /usr/local/bin/

      - name: Setup SSH for deployment
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          cat >> ~/.ssh/config << 'EOF'
          Host homemachine
            HostName ssh.shinbunbun.com
            User deploy
            IdentityFile ~/.ssh/deploy_key
            ProxyCommand cloudflared access ssh --hostname %h
            StrictHostKeyChecking no
          EOF

      - name: Test SSH connectivity
        run: |
          ssh homemachine 'echo "SSH connection via Cloudflare Tunnel OK"'
        timeout-minutes: 2

      - name: Deploy to homeMachine
        run: |
          nix run github:serokell/deploy-rs -- \
            --skip-checks \
            .#homeMachine

      - name: Post-deployment health check
        id: health-check
        run: |
          sleep 10
          ssh homemachine 'systemctl is-active atticd && echo "Attic OK" || echo "Warning: Attic not active"'
          ssh homemachine 'systemctl is-active prometheus && echo "Prometheus OK" || echo "Warning: Prometheus not active"'
        continue-on-error: true

      - name: Notify deployment success
        if: success()
        run: |
          curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"content\": \"ðŸš€ **ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸ**\\n\\nCommit: \`${{ github.sha }}\`\\nhttps://github.com/${{ github.repository }}/commit/${{ github.sha }}\"
            }"

      - name: Notify deployment failure
        if: failure()
        run: |
          curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"content\": \"âŒ **ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—**\\n\\nLogs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
            }"
